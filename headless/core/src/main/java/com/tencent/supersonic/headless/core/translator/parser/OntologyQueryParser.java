package com.tencent.supersonic.headless.core.translator.parser;

import com.alibaba.fastjson.JSONObject;
import com.tencent.supersonic.headless.core.pojo.Ontology;
import com.tencent.supersonic.headless.core.pojo.QueryStatement;
import com.tencent.supersonic.headless.core.translator.parser.calcite.RuntimeOptions;
import com.tencent.supersonic.headless.core.translator.parser.calcite.S2CalciteSchema;
import com.tencent.supersonic.headless.core.translator.parser.calcite.SqlBuilder;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.FileUtils;
import org.springframework.stereotype.Component;

import java.io.File;
import java.util.Objects;

/** the calcite parse implements */
@Component("OntologyQueryParser")
@Slf4j
public class OntologyQueryParser implements QueryParser {

    @Override
    public boolean accept(QueryStatement queryStatement) {
        return Objects.nonNull(queryStatement.getOntologyQuery());
    }

    @Override
    public void parse(QueryStatement queryStatement) throws Exception {
        Ontology ontology = queryStatement.getOntology();
        S2CalciteSchema semanticSchema = S2CalciteSchema.builder()
                .schemaKey("DATASET_" + queryStatement.getDataSetId()).ontology(ontology)
                .runtimeOptions(RuntimeOptions.builder().minMaxTime(queryStatement.getMinMaxTime())
                        .enableOptimize(queryStatement.getEnableOptimize()).build())
                .build();
        SqlBuilder sqlBuilder = new SqlBuilder(semanticSchema);
        String sql = sqlBuilder.buildOntologySql(queryStatement);
        System.out.println("-------final--------");
        System.out.println(sql);
        queryStatement.setSql(sql);
    }

    public static void main(String[] args) throws Exception {

        JSONObject obj1 = JSONObject.parseObject(JSON);
        JSONObject obj2 = JSONObject.parseObject(JSON2);
        System.out.println(obj2.equals(obj1));

        QueryStatement statement = JSONObject.parseObject(JSON3, QueryStatement.class);
        new OntologyQueryParser().parse(statement);

//        QueryStatement statement = JSONObject.parseObject(FileUtils.readFileToString(new File("/Users/lang.ming/Downloads/1.json"),"UTF-8"), QueryStatement.class);
//        new OntologyQueryParser().parse(statement);
    }

    private static final String JSON = """
            {"dataSetId":1,"enableOptimize":true,"isS2SQL":true,"isTranslated":false,"limit":1000,"ontology":{"dataModelMap":{"user_department":{"aggTime":"none","dimensions":[{"bizName":"department","dataType":"UNKNOWN","expr":"department","name":"department"}],"id":1,"identifiers":[{"name":"user_name","type":"primary"}],"measures":[],"modelId":1,"name":"user_department","sqlQuery":"select user_name,department from s2_user_department","type":"postgresql"},"s2_pv_uv_statis":{"aggTime":"none","dimensions":[{"bizName":"imp_date","dataType":"UNKNOWN","dimensionTimeTypeParams":{"isPrimary":"true","timeGranularity":"day"},"expr":"imp_date","name":"imp_date"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","name":"page"}],"id":2,"identifiers":[{"name":"user_name","type":"foreign"}],"measures":[{"agg":"SUM","expr":"pv","name":"pv"},{"agg":"SUM","expr":"user_id","name":"user_id"}],"modelId":1,"name":"s2_pv_uv_statis","sqlQuery":"SELECT imp_date, user_name, page, 1 as pv, user_name as user_id FROM s2_pv_uv_statis","type":"postgresql"},"s2_stay_time_statis":{"aggTime":"none","dimensions":[{"bizName":"imp_date","dataType":"UNKNOWN","dimensionTimeTypeParams":{"isPrimary":"true","timeGranularity":"day"},"expr":"imp_date","name":"imp_date"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","name":"page"}],"id":3,"identifiers":[{"name":"user_name","type":"foreign"}],"measures":[{"agg":"SUM","expr":"stay_hours","name":"stay_hours"}],"modelId":1,"name":"s2_stay_time_statis","sqlQuery":"select imp_date,user_name,stay_hours,page from s2_stay_time_statis","type":"postgresql"}},"database":{"admins":[],"createdAt":1740496582140,"createdBy":"admin","description":"样例数据库实例仅用于体验","hasEditPermission":false,"hasPermission":false,"hasUsePermission":false,"id":1,"name":"S2数据库DEMO","password":"rZxw05tLTEAakUc9TOtSog==","type":"postgresql","updatedAt":1740496582140,"updatedBy":"admin","url":"jdbc:h2:mem:semantic;DATABASE_TO_UPPER=false;QUERY_TIMEOUT=30","username":"root","viewers":[]},"dimensionMap":{"user_department":[{"bizName":"department","dataType":"UNKNOWN","expr":"department","ext":{},"name":"department","owners":"admin"},{"bizName":"user_name","dataType":"UNKNOWN","expr":"user_name","ext":{},"name":"user_name","owners":"admin"}],"s2_pv_uv_statis":[],"s2_stay_time_statis":[{"bizName":"imp_date","dataType":"UNKNOWN","expr":"imp_date","ext":{"time_format":"yyyy-MM-dd"},"name":"imp_date","owners":"admin"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","ext":{},"name":"page","owners":"admin"}]},"joinRelations":[{"id":1,"joinCondition":[{"left":"user_name","middle":"=","right":"user_name"}],"joinType":"left join","left":"s2_pv_uv_statis","right":"user_department"},{"id":2,"joinCondition":[{"left":"user_name","middle":"=","right":"user_name"}],"joinType":"left join","left":"s2_stay_time_statis","right":"user_department"}],"materializationList":[],"metrics":[{"metricTypeParams":{"expr":"pv","measures":[{"agg":"SUM","name":"pv"}]},"name":"pv","owners":["admin"],"type":"ATOMIC"},{"metricTypeParams":{"expr":"stay_hours","measures":[{"agg":"SUM","name":"stay_hours"}]},"name":"stay_hours","owners":["admin"],"type":"ATOMIC"},{"metricTypeParams":{"expr":"user_name","measures":[{"expr":"user_name","name":"user_name"}]},"name":"uv","owners":["admin"],"type":"DERIVED"}]},"ontologyQuery":{"aggOption":"NATIVE","dimensions":["user_name","imp_date"],"metrics":["stay_hours"],"nativeQuery":true},"semanticSchema":{"dataSetId":1,"databaseResp":{"$ref":"$.ontology.dataModelMap.dimensions.database"},"dimensions":[{"bizName":"department","createdAt":1740496582239,"createdBy":"admin","description":"","domainId":1,"expr":"department","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0].ext"},"fields":[],"id":1,"isTag":0,"modelBizName":"user_department","modelId":1,"modelName":"用户部门","name":"部门","semanticType":"CATEGORY","sensitiveLevel":0,"status":1,"type":"categorical","typeEnum":"DIMENSION","updatedAt":1740496582239,"updatedBy":"admin","useCnt":0},{"bizName":"user_name","createdAt":1740496582241,"createdBy":"admin","description":"用户","domainId":1,"expr":"user_name","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1].ext"},"fields":[],"id":2,"isTag":0,"modelBizName":"user_department","modelId":1,"modelName":"用户部门","name":"用户","semanticType":"CATEGORY","sensitiveLevel":0,"status":1,"type":"primary_key","typeEnum":"DIMENSION","updatedAt":1740496582241,"updatedBy":"admin","useCnt":0},{"bizName":"imp_date","createdAt":1740496582300,"createdBy":"admin","description":"","domainId":1,"expr":"imp_date","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1][0].ext"},"fields":[],"id":3,"isTag":0,"modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"数据日期","semanticType":"DATE","sensitiveLevel":0,"status":1,"type":"partition_time","typeEnum":"DIMENSION","updatedAt":1740496582300,"updatedBy":"admin","useCnt":0},{"bizName":"page","createdAt":1740496582300,"createdBy":"admin","description":"页面","dimValueMaps":[],"domainId":1,"expr":"page","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1][0][1].ext"},"fields":[],"id":4,"isTag":0,"modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"页面","semanticType":"CATEGORY","sensitiveLevel":1,"status":1,"type":"categorical","typeEnum":"DIMENSION","updatedAt":1740496582333,"updatedBy":"admin","useCnt":0}],"metrics":[{"bizName":"pv","containsPartitionDimensions":false,"createdAt":1740496582281,"createdBy":"admin","defaultAgg":"SUM","description":"一段时间内用户的访问次数","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":1,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByMeasureParams":{"expr":"pv","measures":[{"agg":"SUM","bizName":"pv","expr":"pv","isCreateMetric":0,"name":"访问次数"}]},"metricDefineType":"MEASURE","modelBizName":"s2_pv_uv_statis","modelId":2,"modelName":"PVUV统计","name":"访问次数","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false},{"dimensionId":2,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":0,"similarity":0.0,"status":1,"type":"ATOMIC","typeEnum":"METRIC","updatedAt":1740496582401,"updatedBy":"admin","useCnt":0},{"bizName":"stay_hours","containsPartitionDimensions":false,"createdAt":1740496582305,"createdBy":"admin","defaultAgg":"SUM","description":"停留时长","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":2,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByMeasureParams":{"expr":"stay_hours","measures":[{"agg":"SUM","bizName":"stay_hours","expr":"stay_hours","isCreateMetric":0,"name":"停留时长"}]},"metricDefineType":"MEASURE","modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"停留时长","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false},{"dimensionId":2,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":2,"similarity":0.0,"status":1,"type":"ATOMIC","typeEnum":"METRIC","updatedAt":1740496582393,"updatedBy":"admin","useCnt":0},{"alias":"UV,访问人数","bizName":"uv","containsPartitionDimensions":false,"createdAt":1740496582405,"createdBy":"admin","defaultAgg":"count","description":"访问的用户个数","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":3,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByFieldParams":{"expr":"count(distinct user_name)","fields":[{"fieldName":"user_name"}]},"metricDefineType":"FIELD","modelBizName":"s2_pv_uv_statis","modelId":2,"modelName":"PVUV统计","name":"访问用户数","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":0,"similarity":0.0,"status":1,"type":"DERIVED","typeEnum":"METRIC","updatedAt":1740496582405,"updatedBy":"admin","useCnt":0}],"modelIds":[1,2,3],"modelRelas":[{"domainId":1,"fromModelId":2,"id":1,"joinConditions":[{"leftField":"user_name","operator":"=","rightField":"user_name"}],"joinType":"left join","toModelId":1},{"domainId":1,"fromModelId":3,"id":2,"joinConditions":[{"leftField":"user_name","operator":"=","rightField":"user_name"}],"joinType":"left join","toModelId":1}],"modelResps":[{"adminOrgs":[],"admins":["admin","alice"],"bizName":"user_department","createdAt":1740496582193,"createdBy":"admin","databaseId":1,"description":"用户部门信息","domainId":1,"id":1,"modelDetail":{"dimensions":[{"bizName":"department","dateFormat":"yyyy-MM-dd","expr":"department","isCreateDimension":1,"name":"部门","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Varchar","fieldName":"department"}],"identifiers":[{"bizName":"user_name","isCreateDimension":1,"name":"用户","type":"primary"}],"measures":[],"queryType":"sql_query","sqlQuery":"select user_name,department from s2_user_department","sqlVariables":[]},"name":"用户部门","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740496582193,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]},{"adminOrgs":[],"admins":["admin"],"bizName":"s2_pv_uv_statis","createdAt":1740496582267,"createdBy":"admin","databaseId":1,"description":"PVUV统计","domainId":1,"id":2,"modelDetail":{"dimensions":[{"bizName":"imp_date","dateFormat":"yyyy-MM-dd","expr":"imp_date","isCreateDimension":0,"name":"","type":"partition_time","typeParams":{"isPrimary":"true","timeGranularity":"day"}},{"bizName":"page","dateFormat":"yyyy-MM-dd","expr":"page","isCreateDimension":0,"name":"","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Date","fieldName":"imp_date"},{"dataType":"Varchar","fieldName":"page"},{"dataType":"Long","fieldName":"pv"},{"dataType":"Varchar","fieldName":"user_id"}],"identifiers":[{"bizName":"user_name","isCreateDimension":0,"name":"用户名","type":"foreign"}],"measures":[{"agg":"SUM","bizName":"pv","expr":"pv","isCreateMetric":1,"name":"访问次数"},{"agg":"SUM","bizName":"user_id","expr":"user_id","isCreateMetric":0,"name":"访问用户数"}],"queryType":"sql_query","sqlQuery":"SELECT imp_date, user_name, page, 1 as pv, user_name as user_id FROM s2_pv_uv_statis","sqlVariables":[]},"name":"PVUV统计","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740496582267,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]},{"adminOrgs":[],"admins":["admin"],"bizName":"s2_stay_time_statis","createdAt":1740496582297,"createdBy":"admin","databaseId":1,"description":"停留时长统计","domainId":1,"id":3,"modelDetail":{"dimensions":[{"bizName":"imp_date","dateFormat":"yyyy-MM-dd","expr":"imp_date","isCreateDimension":1,"name":"数据日期","type":"partition_time","typeParams":{"isPrimary":"true","timeGranularity":"day"}},{"bizName":"page","dateFormat":"yyyy-MM-dd","expr":"page","isCreateDimension":1,"name":"页面","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Date","fieldName":"imp_date"},{"dataType":"Varchar","fieldName":"page"},{"dataType":"Double","fieldName":"stay_hours"}],"identifiers":[{"bizName":"user_name","isCreateDimension":0,"name":"用户","type":"foreign"}],"measures":[{"agg":"SUM","bizName":"stay_hours","expr":"stay_hours","isCreateMetric":1,"name":"停留时长"}],"queryType":"sql_query","sqlQuery":"select imp_date,user_name,stay_hours,page from s2_stay_time_statis","sqlVariables":[]},"name":"停留时长统计","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740496582297,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]}],"schemaType":"DATASET","tags":[]},"sql":"SELECT SUM(stay_hours) AS _停留时长_ FROM t_1 WHERE (user_name = 'alice') AND (imp_date >= '2025-02-18' AND imp_date <= '2025-02-25')","sqlQuery":{"sql":"SELECT SUM(stay_hours) AS _停留时长_ FROM t_1 WHERE (user_name = 'alice') AND (imp_date >= '2025-02-18' AND imp_date <= '2025-02-25')","supportWith":true,"table":"t_1","withAlias":true},"status":0}
            """;

    private static final String JSON2 = """
            {"dataSetId":1,"enableOptimize":true,"isS2SQL":true,"isTranslated":false,"limit":1000,"ontology":{"dataModelMap":{"user_department":{"aggTime":"none","dimensions":[{"bizName":"department","dataType":"UNKNOWN","expr":"department","name":"department"}],"id":1,"identifiers":[{"name":"user_name","type":"primary"}],"measures":[],"modelId":1,"name":"user_department","sqlQuery":"select user_name,department from s2_user_department","type":"postgresql"},"s2_pv_uv_statis":{"aggTime":"none","dimensions":[{"bizName":"imp_date","dataType":"UNKNOWN","dimensionTimeTypeParams":{"isPrimary":"true","timeGranularity":"day"},"expr":"imp_date","name":"imp_date"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","name":"page"}],"id":2,"identifiers":[{"name":"user_name","type":"foreign"}],"measures":[{"agg":"SUM","expr":"pv","name":"pv"},{"agg":"SUM","expr":"user_id","name":"user_id"}],"modelId":1,"name":"s2_pv_uv_statis","sqlQuery":"SELECT imp_date, user_name, page, 1 as pv, user_name as user_id FROM s2_pv_uv_statis","type":"postgresql"},"s2_stay_time_statis":{"aggTime":"none","dimensions":[{"bizName":"imp_date","dataType":"UNKNOWN","dimensionTimeTypeParams":{"isPrimary":"true","timeGranularity":"day"},"expr":"imp_date","name":"imp_date"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","name":"page"}],"id":3,"identifiers":[{"name":"user_name","type":"foreign"}],"measures":[{"agg":"SUM","expr":"stay_hours","name":"stay_hours"}],"modelId":1,"name":"s2_stay_time_statis","sqlQuery":"select imp_date,user_name,stay_hours,page from s2_stay_time_statis","type":"postgresql"}},"database":{"admins":[],"createdAt":1740497283715,"createdBy":"admin","description":"样例数据库实例仅用于体验","hasEditPermission":false,"hasPermission":false,"hasUsePermission":false,"id":1,"name":"S2数据库DEMO","password":"rZxw05tLTEAakUc9TOtSog==","type":"postgresql","updatedAt":1740497283715,"updatedBy":"admin","url":"jdbc:h2:mem:semantic;DATABASE_TO_UPPER=false;QUERY_TIMEOUT=30","username":"root","viewers":[]},"dimensionMap":{"user_department":[{"bizName":"department","dataType":"UNKNOWN","expr":"department","ext":{},"name":"department","owners":"admin"},{"bizName":"user_name","dataType":"UNKNOWN","expr":"user_name","ext":{},"name":"user_name","owners":"admin"}],"s2_pv_uv_statis":[],"s2_stay_time_statis":[{"bizName":"imp_date","dataType":"UNKNOWN","expr":"imp_date","ext":{"time_format":"yyyy-MM-dd"},"name":"imp_date","owners":"admin"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","ext":{},"name":"page","owners":"admin"}]},"joinRelations":[{"id":1,"joinCondition":[{"left":"user_name","middle":"=","right":"user_name"}],"joinType":"left join","left":"s2_pv_uv_statis","right":"user_department"},{"id":2,"joinCondition":[{"left":"user_name","middle":"=","right":"user_name"}],"joinType":"left join","left":"s2_stay_time_statis","right":"user_department"}],"materializationList":[],"metrics":[{"metricTypeParams":{"expr":"pv","measures":[{"agg":"SUM","name":"pv"}]},"name":"pv","owners":["admin"],"type":"ATOMIC"},{"metricTypeParams":{"expr":"stay_hours","measures":[{"agg":"SUM","name":"stay_hours"}]},"name":"stay_hours","owners":["admin"],"type":"ATOMIC"},{"metricTypeParams":{"expr":"user_name","measures":[{"expr":"user_name","name":"user_name"}]},"name":"uv","owners":["admin"],"type":"DERIVED"}]},"ontologyQuery":{"aggOption":"NATIVE","dimensions":["user_name","imp_date","department"],"metrics":["pv","stay_hours"],"nativeQuery":true},"semanticSchema":{"dataSetId":1,"databaseResp":{"$ref":"$.ontology.dataModelMap.dimensions.database"},"dimensions":[{"bizName":"department","createdAt":1740497283988,"createdBy":"admin","description":"","domainId":1,"expr":"department","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0].ext"},"fields":[],"id":1,"isTag":0,"modelBizName":"user_department","modelId":1,"modelName":"用户部门","name":"部门","semanticType":"CATEGORY","sensitiveLevel":0,"status":1,"type":"categorical","typeEnum":"DIMENSION","updatedAt":1740497283988,"updatedBy":"admin","useCnt":0},{"bizName":"user_name","createdAt":1740497283991,"createdBy":"admin","description":"用户","domainId":1,"expr":"user_name","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1].ext"},"fields":[],"id":2,"isTag":0,"modelBizName":"user_department","modelId":1,"modelName":"用户部门","name":"用户","semanticType":"CATEGORY","sensitiveLevel":0,"status":1,"type":"primary_key","typeEnum":"DIMENSION","updatedAt":1740497283991,"updatedBy":"admin","useCnt":0},{"bizName":"imp_date","createdAt":1740497284159,"createdBy":"admin","description":"","domainId":1,"expr":"imp_date","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1][0].ext"},"fields":[],"id":3,"isTag":0,"modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"数据日期","semanticType":"DATE","sensitiveLevel":0,"status":1,"type":"partition_time","typeEnum":"DIMENSION","updatedAt":1740497284159,"updatedBy":"admin","useCnt":0},{"bizName":"page","createdAt":1740497284159,"createdBy":"admin","description":"页面","dimValueMaps":[],"domainId":1,"expr":"page","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1][0][1].ext"},"fields":[],"id":4,"isTag":0,"modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"页面","semanticType":"CATEGORY","sensitiveLevel":1,"status":1,"type":"categorical","typeEnum":"DIMENSION","updatedAt":1740497284260,"updatedBy":"admin","useCnt":0}],"metrics":[{"bizName":"pv","containsPartitionDimensions":false,"createdAt":1740497284110,"createdBy":"admin","defaultAgg":"SUM","description":"一段时间内用户的访问次数","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":1,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByMeasureParams":{"expr":"pv","measures":[{"agg":"SUM","bizName":"pv","expr":"pv","isCreateMetric":0,"name":"访问次数"}]},"metricDefineType":"MEASURE","modelBizName":"s2_pv_uv_statis","modelId":2,"modelName":"PVUV统计","name":"访问次数","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false},{"dimensionId":2,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":0,"similarity":0.0,"status":1,"type":"ATOMIC","typeEnum":"METRIC","updatedAt":1740497284430,"updatedBy":"admin","useCnt":0},{"bizName":"stay_hours","containsPartitionDimensions":false,"createdAt":1740497284178,"createdBy":"admin","defaultAgg":"SUM","description":"停留时长","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":2,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByMeasureParams":{"expr":"stay_hours","measures":[{"agg":"SUM","bizName":"stay_hours","expr":"stay_hours","isCreateMetric":0,"name":"停留时长"}]},"metricDefineType":"MEASURE","modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"停留时长","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false},{"dimensionId":2,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":2,"similarity":0.0,"status":1,"type":"ATOMIC","typeEnum":"METRIC","updatedAt":1740497284406,"updatedBy":"admin","useCnt":0},{"alias":"UV,访问人数","bizName":"uv","containsPartitionDimensions":false,"createdAt":1740497284440,"createdBy":"admin","defaultAgg":"count","description":"访问的用户个数","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":3,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByFieldParams":{"expr":"count(distinct user_name)","fields":[{"fieldName":"user_name"}]},"metricDefineType":"FIELD","modelBizName":"s2_pv_uv_statis","modelId":2,"modelName":"PVUV统计","name":"访问用户数","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":0,"similarity":0.0,"status":1,"type":"DERIVED","typeEnum":"METRIC","updatedAt":1740497284440,"updatedBy":"admin","useCnt":0}],"modelIds":[1,2,3],"modelRelas":[{"domainId":1,"fromModelId":2,"id":1,"joinConditions":[{"leftField":"user_name","operator":"=","rightField":"user_name"}],"joinType":"left join","toModelId":1},{"domainId":1,"fromModelId":3,"id":2,"joinConditions":[{"leftField":"user_name","operator":"=","rightField":"user_name"}],"joinType":"left join","toModelId":1}],"modelResps":[{"adminOrgs":[],"admins":["admin","alice"],"bizName":"user_department","createdAt":1740497283855,"createdBy":"admin","databaseId":1,"description":"用户部门信息","domainId":1,"id":1,"modelDetail":{"dimensions":[{"bizName":"department","dateFormat":"yyyy-MM-dd","expr":"department","isCreateDimension":1,"name":"部门","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Varchar","fieldName":"department"}],"identifiers":[{"bizName":"user_name","isCreateDimension":1,"name":"用户","type":"primary"}],"measures":[],"queryType":"sql_query","sqlQuery":"select user_name,department from s2_user_department","sqlVariables":[]},"name":"用户部门","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740497283855,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]},{"adminOrgs":[],"admins":["admin"],"bizName":"s2_pv_uv_statis","createdAt":1740497284071,"createdBy":"admin","databaseId":1,"description":"PVUV统计","domainId":1,"id":2,"modelDetail":{"dimensions":[{"bizName":"imp_date","dateFormat":"yyyy-MM-dd","expr":"imp_date","isCreateDimension":0,"name":"","type":"partition_time","typeParams":{"isPrimary":"true","timeGranularity":"day"}},{"bizName":"page","dateFormat":"yyyy-MM-dd","expr":"page","isCreateDimension":0,"name":"","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Date","fieldName":"imp_date"},{"dataType":"Varchar","fieldName":"page"},{"dataType":"Long","fieldName":"pv"},{"dataType":"Varchar","fieldName":"user_id"}],"identifiers":[{"bizName":"user_name","isCreateDimension":0,"name":"用户名","type":"foreign"}],"measures":[{"agg":"SUM","bizName":"pv","expr":"pv","isCreateMetric":1,"name":"访问次数"},{"agg":"SUM","bizName":"user_id","expr":"user_id","isCreateMetric":0,"name":"访问用户数"}],"queryType":"sql_query","sqlQuery":"SELECT imp_date, user_name, page, 1 as pv, user_name as user_id FROM s2_pv_uv_statis","sqlVariables":[]},"name":"PVUV统计","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740497284071,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]},{"adminOrgs":[],"admins":["admin"],"bizName":"s2_stay_time_statis","createdAt":1740497284151,"createdBy":"admin","databaseId":1,"description":"停留时长统计","domainId":1,"id":3,"modelDetail":{"dimensions":[{"bizName":"imp_date","dateFormat":"yyyy-MM-dd","expr":"imp_date","isCreateDimension":1,"name":"数据日期","type":"partition_time","typeParams":{"isPrimary":"true","timeGranularity":"day"}},{"bizName":"page","dateFormat":"yyyy-MM-dd","expr":"page","isCreateDimension":1,"name":"页面","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Date","fieldName":"imp_date"},{"dataType":"Varchar","fieldName":"page"},{"dataType":"Double","fieldName":"stay_hours"}],"identifiers":[{"bizName":"user_name","isCreateDimension":0,"name":"用户","type":"foreign"}],"measures":[{"agg":"SUM","bizName":"stay_hours","expr":"stay_hours","isCreateMetric":1,"name":"停留时长"}],"queryType":"sql_query","sqlQuery":"select imp_date,user_name,stay_hours,page from s2_stay_time_statis","sqlVariables":[]},"name":"停留时长统计","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740497284151,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]}],"schemaType":"DATASET","tags":[]},"sql":"SELECT department, SUM(stay_hours) AS _停留时长_, SUM(pv) AS _访问次数_, COUNT(user_name) AS _UV_, imp_date FROM t_1 WHERE (user_name = 'alice') AND (imp_date >= '2025-02-18' AND imp_date <= '2025-02-25') GROUP BY department, imp_date","sqlQuery":{"sql":"SELECT department, SUM(stay_hours) AS _停留时长_, SUM(pv) AS _访问次数_, COUNT(user_name) AS _UV_, imp_date FROM t_1 WHERE (user_name = 'alice') AND (imp_date >= '2025-02-18' AND imp_date <= '2025-02-25') GROUP BY department, imp_date","supportWith":true,"table":"t_1","withAlias":true},"status":0}
            """;

    private static final String JSON3 = """
            {"dataSetId":1,"enableOptimize":true,"isS2SQL":true,"isTranslated":false,"limit":1000,"ontology":{"dataModelMap":{"user_department":{"aggTime":"none","dimensions":[{"bizName":"department","dataType":"UNKNOWN","expr":"department","name":"department"}],"id":1,"identifiers":[{"name":"user_name","type":"primary"}],"measures":[],"modelId":1,"name":"user_department","sqlQuery":"select user_name,department from s2_user_department","type":"postgresql"},"s2_pv_uv_statis":{"aggTime":"none","dimensions":[{"bizName":"imp_date","dataType":"UNKNOWN","dimensionTimeTypeParams":{"isPrimary":"true","timeGranularity":"day"},"expr":"imp_date","name":"imp_date"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","name":"page"}],"id":2,"identifiers":[{"name":"user_name","type":"foreign"}],"measures":[{"agg":"SUM","expr":"pv","name":"pv"},{"agg":"SUM","expr":"user_id","name":"user_id"}],"modelId":1,"name":"s2_pv_uv_statis","sqlQuery":"SELECT imp_date, user_name, page, 1 as pv, user_name as user_id FROM s2_pv_uv_statis","type":"postgresql"},"s2_stay_time_statis":{"aggTime":"none","dimensions":[{"bizName":"imp_date","dataType":"UNKNOWN","dimensionTimeTypeParams":{"isPrimary":"true","timeGranularity":"day"},"expr":"imp_date","name":"imp_date"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","name":"page"}],"id":3,"identifiers":[{"name":"user_name","type":"foreign"}],"measures":[{"agg":"SUM","expr":"stay_hours","name":"stay_hours"}],"modelId":1,"name":"s2_stay_time_statis","sqlQuery":"select imp_date,user_name,stay_hours,page from s2_stay_time_statis","type":"postgresql"}},"database":{"admins":[],"createdAt":1740502316003,"createdBy":"admin","description":"样例数据库实例仅用于体验","hasEditPermission":false,"hasPermission":false,"hasUsePermission":false,"id":1,"name":"S2数据库DEMO","password":"rZxw05tLTEAakUc9TOtSog==","type":"postgresql","updatedAt":1740502316003,"updatedBy":"admin","url":"jdbc:h2:mem:semantic;DATABASE_TO_UPPER=false;QUERY_TIMEOUT=30","username":"root","viewers":[]},"dimensionMap":{"user_department":[{"bizName":"department","dataType":"UNKNOWN","expr":"department","ext":{},"name":"department","owners":"admin"},{"bizName":"user_name","dataType":"UNKNOWN","expr":"user_name","ext":{},"name":"user_name","owners":"admin"}],"s2_pv_uv_statis":[],"s2_stay_time_statis":[{"bizName":"imp_date","dataType":"UNKNOWN","expr":"imp_date","ext":{"time_format":"yyyy-MM-dd"},"name":"imp_date","owners":"admin"},{"bizName":"page","dataType":"UNKNOWN","expr":"page","ext":{},"name":"page","owners":"admin"}]},"joinRelations":[{"id":1,"joinCondition":[{"left":"user_name","middle":"=","right":"user_name"}],"joinType":"left join","left":"s2_pv_uv_statis","right":"user_department"},{"id":2,"joinCondition":[{"left":"user_name","middle":"=","right":"user_name"}],"joinType":"left join","left":"s2_stay_time_statis","right":"user_department"}],"materializationList":[],"metrics":[{"metricTypeParams":{"expr":"pv","measures":[{"agg":"SUM","name":"pv"}]},"name":"pv","owners":["admin"],"type":"ATOMIC"},{"metricTypeParams":{"expr":"stay_hours","measures":[{"agg":"SUM","name":"stay_hours"}]},"name":"stay_hours","owners":["admin"],"type":"ATOMIC"},{"metricTypeParams":{"expr":"user_name","measures":[{"expr":"user_name","name":"user_name"}]},"name":"uv","owners":["admin"],"type":"DERIVED"}]},"ontologyQuery":{"aggOption":"NATIVE","dimensions":["imp_date","department"],"metrics":["pv"],"nativeQuery":true},"semanticSchema":{"dataSetId":1,"databaseResp":{"$ref":"$.ontology.dataModelMap.dimensions.database"},"dimensions":[{"bizName":"department","createdAt":1740502316108,"createdBy":"admin","description":"","domainId":1,"expr":"department","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0].ext"},"fields":[],"id":1,"isTag":0,"modelBizName":"user_department","modelId":1,"modelName":"用户部门","name":"部门","semanticType":"CATEGORY","sensitiveLevel":0,"status":1,"type":"categorical","typeEnum":"DIMENSION","updatedAt":1740502316108,"updatedBy":"admin","useCnt":0},{"bizName":"user_name","createdAt":1740502316109,"createdBy":"admin","description":"用户","domainId":1,"expr":"user_name","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1].ext"},"fields":[],"id":2,"isTag":0,"modelBizName":"user_department","modelId":1,"modelName":"用户部门","name":"用户","semanticType":"CATEGORY","sensitiveLevel":0,"status":1,"type":"primary_key","typeEnum":"DIMENSION","updatedAt":1740502316109,"updatedBy":"admin","useCnt":0},{"bizName":"imp_date","createdAt":1740502316169,"createdBy":"admin","description":"","domainId":1,"expr":"imp_date","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1][0].ext"},"fields":[],"id":3,"isTag":0,"modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"数据日期","semanticType":"DATE","sensitiveLevel":0,"status":1,"type":"partition_time","typeEnum":"DIMENSION","updatedAt":1740502316169,"updatedBy":"admin","useCnt":0},{"bizName":"page","createdAt":1740502316170,"createdBy":"admin","description":"页面","dimValueMaps":[],"domainId":1,"expr":"page","ext":{"$ref":"$.ontology.dataModelMap.dimensions.dimensionMap[0][1][0][1].ext"},"fields":[],"id":4,"isTag":0,"modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"页面","semanticType":"CATEGORY","sensitiveLevel":1,"status":1,"type":"categorical","typeEnum":"DIMENSION","updatedAt":1740502316200,"updatedBy":"admin","useCnt":0}],"metrics":[{"bizName":"pv","containsPartitionDimensions":false,"createdAt":1740502316150,"createdBy":"admin","defaultAgg":"SUM","description":"一段时间内用户的访问次数","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":1,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByMeasureParams":{"expr":"pv","measures":[{"agg":"SUM","bizName":"pv","expr":"pv","isCreateMetric":0,"name":"访问次数"}]},"metricDefineType":"MEASURE","modelBizName":"s2_pv_uv_statis","modelId":2,"modelName":"PVUV统计","name":"访问次数","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false},{"dimensionId":2,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":0,"similarity":0.0,"status":1,"type":"ATOMIC","typeEnum":"METRIC","updatedAt":1740502316264,"updatedBy":"admin","useCnt":0},{"bizName":"stay_hours","containsPartitionDimensions":false,"createdAt":1740502316175,"createdBy":"admin","defaultAgg":"SUM","description":"停留时长","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":2,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByMeasureParams":{"expr":"stay_hours","measures":[{"agg":"SUM","bizName":"stay_hours","expr":"stay_hours","isCreateMetric":0,"name":"停留时长"}]},"metricDefineType":"MEASURE","modelBizName":"s2_stay_time_statis","modelId":3,"modelName":"停留时长统计","name":"停留时长","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false},{"dimensionId":2,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":2,"similarity":0.0,"status":1,"type":"ATOMIC","typeEnum":"METRIC","updatedAt":1740502316256,"updatedBy":"admin","useCnt":0},{"alias":"UV,访问人数","bizName":"uv","containsPartitionDimensions":false,"createdAt":1740502316268,"createdBy":"admin","defaultAgg":"count","description":"访问的用户个数","domainId":1,"ext":{},"fields":[],"hasAdminRes":false,"id":3,"isCollect":false,"isPublish":0,"isTag":0,"metricDefineByFieldParams":{"expr":"count(distinct user_name)","fields":[{"fieldName":"user_name"}]},"metricDefineType":"FIELD","modelBizName":"s2_pv_uv_statis","modelId":2,"modelName":"PVUV统计","name":"访问用户数","relateDimension":{"drillDownDimensions":[{"dimensionId":1,"inheritedFromModel":false,"necessary":false}]},"sensitiveLevel":0,"similarity":0.0,"status":1,"type":"DERIVED","typeEnum":"METRIC","updatedAt":1740502316268,"updatedBy":"admin","useCnt":0}],"modelIds":[1,2,3],"modelRelas":[{"domainId":1,"fromModelId":2,"id":1,"joinConditions":[{"leftField":"user_name","operator":"=","rightField":"user_name"}],"joinType":"left join","toModelId":1},{"domainId":1,"fromModelId":3,"id":2,"joinConditions":[{"leftField":"user_name","operator":"=","rightField":"user_name"}],"joinType":"left join","toModelId":1}],"modelResps":[{"adminOrgs":[],"admins":["admin","alice"],"bizName":"user_department","createdAt":1740502316057,"createdBy":"admin","databaseId":1,"description":"用户部门信息","domainId":1,"id":1,"modelDetail":{"dimensions":[{"bizName":"department","dateFormat":"yyyy-MM-dd","expr":"department","isCreateDimension":1,"name":"部门","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Varchar","fieldName":"department"}],"identifiers":[{"bizName":"user_name","isCreateDimension":1,"name":"用户","type":"primary"}],"measures":[],"queryType":"sql_query","sqlQuery":"select user_name,department from s2_user_department","sqlVariables":[]},"name":"用户部门","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740502316057,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]},{"adminOrgs":[],"admins":["admin"],"bizName":"s2_pv_uv_statis","createdAt":1740502316137,"createdBy":"admin","databaseId":1,"description":"PVUV统计","domainId":1,"id":2,"modelDetail":{"dimensions":[{"bizName":"imp_date","dateFormat":"yyyy-MM-dd","expr":"imp_date","isCreateDimension":0,"name":"","type":"partition_time","typeParams":{"isPrimary":"true","timeGranularity":"day"}},{"bizName":"page","dateFormat":"yyyy-MM-dd","expr":"page","isCreateDimension":0,"name":"","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Date","fieldName":"imp_date"},{"dataType":"Varchar","fieldName":"page"},{"dataType":"Long","fieldName":"pv"},{"dataType":"Varchar","fieldName":"user_id"}],"identifiers":[{"bizName":"user_name","isCreateDimension":0,"name":"用户名","type":"foreign"}],"measures":[{"agg":"SUM","bizName":"pv","expr":"pv","isCreateMetric":1,"name":"访问次数"},{"agg":"SUM","bizName":"user_id","expr":"user_id","isCreateMetric":0,"name":"访问用户数"}],"queryType":"sql_query","sqlQuery":"SELECT imp_date, user_name, page, 1 as pv, user_name as user_id FROM s2_pv_uv_statis","sqlVariables":[]},"name":"PVUV统计","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740502316137,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]},{"adminOrgs":[],"admins":["admin"],"bizName":"s2_stay_time_statis","createdAt":1740502316166,"createdBy":"admin","databaseId":1,"description":"停留时长统计","domainId":1,"id":3,"modelDetail":{"dimensions":[{"bizName":"imp_date","dateFormat":"yyyy-MM-dd","expr":"imp_date","isCreateDimension":1,"name":"数据日期","type":"partition_time","typeParams":{"isPrimary":"true","timeGranularity":"day"}},{"bizName":"page","dateFormat":"yyyy-MM-dd","expr":"page","isCreateDimension":1,"name":"页面","type":"categorical"}],"fields":[{"dataType":"Varchar","fieldName":"user_name"},{"dataType":"Date","fieldName":"imp_date"},{"dataType":"Varchar","fieldName":"page"},{"dataType":"Double","fieldName":"stay_hours"}],"identifiers":[{"bizName":"user_name","isCreateDimension":0,"name":"用户","type":"foreign"}],"measures":[{"agg":"SUM","bizName":"stay_hours","expr":"stay_hours","isCreateMetric":1,"name":"停留时长"}],"queryType":"sql_query","sqlQuery":"select imp_date,user_name,stay_hours,page from s2_stay_time_statis","sqlVariables":[]},"name":"停留时长统计","sensitiveLevel":0,"status":1,"tagObjectId":0,"updatedAt":1740502316166,"updatedBy":"admin","viewOrgs":["1"],"viewers":["admin","tom","jack"]}],"schemaType":"DATASET","tags":[]},"sql":"SELECT department, SUM(pv) FROM t_1 WHERE imp_date >= '2025-02-19' AND imp_date <= '2025-02-26' GROUP BY department LIMIT 200","sqlQuery":{"sql":"SELECT department, SUM(pv) FROM t_1 WHERE imp_date >= '2025-02-19' AND imp_date <= '2025-02-26' GROUP BY department LIMIT 200","supportWith":true,"table":"t_1","withAlias":true},"status":0}
            """;
}
